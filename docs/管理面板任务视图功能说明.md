# 管理面板任务视图功能说明

## 概述

管理面板现在采用**任务为中心**的视图设计，能够智能地将音频分离相关的文件按任务进行分组管理，极大提升了文件管理的效率和直观性。

## 主要改进

### 🎯 任务中心视图
- **从文件视图升级为任务视图**：不再简单按文件类型分类，而是按音频分离任务进行智能分组
- **智能文件关联**：自动识别输入文件和输出文件的关联关系
- **任务状态追踪**：显示每个任务的完成状态（已完成/处理中/未知）

### 📊 改进的统计信息
```
总任务数 | 已完成任务 | 总文件大小 | 过期任务数
```

### 🗂️ 任务卡片设计
每个任务以卡片形式展示，包含：
- **任务ID**：唯一标识符（显示前8位）
- **创建时间**：任务开始时间
- **文件统计**：输入文件数量 + 输出文件数量
- **任务状态**：完成状态标识
- **总大小**：该任务所有文件的总大小
- **过期标识**：如果文件超过保留期限

### 📂 可展开的文件详情
点击任务卡片可展开查看：
- **📤 输入文件**：原始音频文件
- **📥 输出文件**：分离后的音轨文件
- **文件操作**：下载、删除单个文件

## 功能特性

### 🔍 智能文件识别算法

#### 输入文件识别
系统通过文件命名模式识别任务关联：
```
原始模式: filename_taskid.ext
示例: song_abc12345.mp3
```

#### 输出文件识别
支持两种识别方式：

1. **文件名匹配**：
   ```
   模式: originalname_stem.ext
   示例: song_vocals.wav, song_drums.wav
   ```

2. **目录结构匹配**：
   ```
   路径: outputs/taskid/files.wav
   示例: outputs/abc12345/song_vocals.wav
   ```

### 🗑️ 任务级别管理

#### 删除整个任务
- 一键删除任务的所有相关文件
- 包括输入文件和所有输出文件
- 自动清理空目录

#### 清理过期任务
- 识别超过保留期限的任务
- 批量删除过期任务
- 释放存储空间

### 📄 孤立文件处理
对于无法关联到任务的文件：
- **单独列出**：在"未归类文件"区域显示
- **类型标识**：标明是输入文件还是输出文件
- **独立管理**：可单独下载或删除

## API 接口

### 获取任务列表
```http
GET /admin/api/files
```

**返回数据结构**：
```json
{
  "status": "success",
  "data": {
    "tasks": [
      {
        "task_id": "abc12345",
        "created_time": 1747988007.16,
        "latest_time": 1747988012.83,
        "status": "completed",
        "is_old": false,
        "total_size": 1024,
        "input_files": [...],
        "output_files": [...]
      }
    ],
    "orphaned_files": [...],
    "summary": {
      "total_tasks": 3,
      "completed_tasks": 3,
      "processing_tasks": 0,
      "old_tasks": 0,
      "total_size": 2048,
      "orphaned_files_count": 1,
      "old_files_count": 0
    }
  }
}
```

### 删除任务
```http
POST /admin/api/tasks/delete
Content-Type: application/json

{
  "task_id": "abc12345"
}
```

## 使用指南

### 1. 查看任务概览
- 登录管理面板：`http://localhost:8080/admin`
- 用户名：`admin`，密码：`admin123`
- 主界面显示所有任务的统计信息

### 2. 管理单个任务
- **展开任务**：点击任务卡片查看详细文件
- **下载输出**：点击输出文件的"下载"按钮
- **删除任务**：点击"删除任务"按钮移除所有相关文件

### 3. 批量操作
- **清理过期文件**：删除所有超期文件
- **清理过期任务**：删除所有过期任务（新功能）
- **清理所有文件**：清空所有上传和输出文件

### 4. 孤立文件管理
- 在"未归类文件"区域查看无法关联的文件
- 可以下载或删除这些文件
- 通常是手动上传或系统异常产生的文件

## 技术优势

### 🎯 用户体验改善
- **更直观的文件组织**：按任务而非文件类型分组
- **减少认知负担**：用户只需关注任务，而非细碎的文件
- **操作效率提升**：可以一次性管理整个任务的所有文件

### 🔧 系统管理优化
- **智能文件关联**：自动识别文件关系，减少管理复杂度
- **精确清理控制**：可以选择性清理特定任务或过期任务
- **存储空间优化**：更好的文件生命周期管理

### 📈 可扩展性
- **支持复杂任务**：可处理多文件输入的复杂音频分离任务
- **兼容现有系统**：完全向下兼容原有的文件结构
- **易于扩展**：为未来功能（如任务历史、进度恢复）提供基础

## 测试验证

运行测试验证功能：
```bash
# 运行管理面板测试
python test/run_tests.py --test admin

# 运行任务视图演示
python test_task_view.py
```

## 注意事项

1. **文件命名规范**：确保上传的文件包含任务ID信息以便正确分组
2. **目录结构**：输出文件建议按任务ID创建子目录
3. **向下兼容**：现有的文件不会丢失，无法识别的会列为孤立文件
4. **性能考虑**：大量文件时建议定期清理过期任务以保持性能

## 总结

新的任务视图让音频分离工作流更加清晰和高效：
- ✅ **任务为中心**的管理模式
- ✅ **智能文件关联**算法
- ✅ **批量任务操作**功能
- ✅ **孤立文件处理**机制
- ✅ **完整的API支持**

这个改进大大提升了文件管理的用户体验，让音频分离项目的管理变得更加直观和高效。 