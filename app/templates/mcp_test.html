<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPåè®®æµ‹è¯• - Demucs éŸ³é¢‘åˆ†ç¦»å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ§ª MCPåè®®æµ‹è¯•</h1>
            <p>äº¤äº’å¼MCP (Model Context Protocol) åŠŸèƒ½æµ‹è¯•å’Œè°ƒè¯•å·¥å…·</p>
            <div class="main-nav">
                <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
                <a href="/mcp" class="nav-link">ğŸ”— MCPåè®®</a>
                <a href="/api-docs" class="nav-link">ğŸ“š APIæ–‡æ¡£</a>
                <a href="/docs" class="nav-link">ğŸ“– ä½¿ç”¨æŒ‡å—</a>
                <a href="/test-guide" class="nav-link">ğŸ§ª æµ‹è¯•æŒ‡å—</a>
                <a href="/admin" class="nav-link">ğŸ› ï¸ ç®¡ç†é¢æ¿</a>
            </div>
        </div>
    </header>
    
    <div class="container container-sm">
        <!-- æµ‹è¯•å¯¼èˆª -->
        <div class="card" style="background: #f8f9fa;">
            <h3>ğŸ¯ æµ‹è¯•ç±»åˆ«</h3>
            <div class="btn-group" style="margin-bottom: 0;">
                <button class="btn btn-primary active" onclick="showTestSection('basic')">åŸºç¡€è¿æ¥</button>
                <button class="btn btn-primary" onclick="showTestSection('tools')">å·¥å…·æµ‹è¯•</button>
                <button class="btn btn-primary" onclick="showTestSection('audio')">éŸ³é¢‘åˆ†ç¦»</button>
                <button class="btn btn-primary" onclick="showTestSection('logs')">å®æ—¶æ—¥å¿—</button>
            </div>
        </div>

        <!-- æœåŠ¡å™¨çŠ¶æ€æ¦‚è§ˆ -->
        <div class="card">
            <h2>ğŸ“Š æœåŠ¡å™¨çŠ¶æ€æ¦‚è§ˆ</h2>
            <div class="grid grid-3">
                <div class="stat-card card-info">
                    <div class="stat-number" id="connection-status">æ£€æŸ¥ä¸­...</div>
                    <div class="stat-label">è¿æ¥çŠ¶æ€</div>
                </div>
                <div class="stat-card card-success">
                    <div class="stat-number" id="tools-count">-</div>
                    <div class="stat-label">å¯ç”¨å·¥å…·</div>
                </div>
                <div class="stat-card card-warning">
                    <div class="stat-number" id="resources-count">-</div>
                    <div class="stat-label">å¯ç”¨èµ„æº</div>
                </div>
            </div>
        </div>

        <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
        <div class="test-section-content" id="basic-section">
            <div class="card">
                <h2>ğŸ”— åŸºç¡€è¿æ¥æµ‹è¯•</h2>
                <p>æµ‹è¯•MCPæœåŠ¡å™¨çš„åŸºæœ¬è¿æ¥å’Œåè®®æ”¯æŒåŠŸèƒ½ã€‚</p>
                
                <div class="grid grid-2">
                    <div class="test-panel">
                        <h4>æœåŠ¡å™¨å¥åº·æ£€æŸ¥</h4>
                        <p class="text-muted">éªŒè¯MCPæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
                        <button class="btn btn-primary w-100" onclick="checkHealth()">
                            ğŸ¥ æ£€æŸ¥å¥åº·çŠ¶æ€
                        </button>
                    </div>
                    
                    <div class="test-panel">
                        <h4>æœåŠ¡å™¨èƒ½åŠ›æŸ¥è¯¢</h4>
                        <p class="text-muted">è·å–æœåŠ¡å™¨æ”¯æŒçš„MCPåè®®èƒ½åŠ›</p>
                        <button class="btn btn-secondary w-100" onclick="getCapabilities()">
                            ğŸ’¡ è·å–æœåŠ¡å™¨èƒ½åŠ›
                        </button>
                    </div>
                </div>
                
                <div class="output-section">
                    <h4>æµ‹è¯•ç»“æœ</h4>
                    <div id="healthOutput" class="output"></div>
                </div>
            </div>
        </div>

        <!-- å·¥å…·å’Œèµ„æºæµ‹è¯• -->
        <div class="test-section-content" id="tools-section" style="display: none;">
            <div class="card">
                <h2>ğŸ› ï¸ å·¥å…·å’Œèµ„æºæµ‹è¯•</h2>
                <p>æµ‹è¯•MCPæœåŠ¡å™¨æä¾›çš„å·¥å…·å’Œèµ„æºåŠŸèƒ½ã€‚</p>
                
                <div class="grid grid-3">
                    <div class="test-panel">
                        <h4>å·¥å…·åˆ—è¡¨</h4>
                        <p class="text-muted">è·å–æ‰€æœ‰å¯ç”¨çš„MCPå·¥å…·</p>
                        <button class="btn btn-primary w-100" onclick="listTools()">
                            ğŸ”§ åˆ—å‡ºå·¥å…·
                        </button>
                    </div>
                    
                    <div class="test-panel">
                        <h4>èµ„æºåˆ—è¡¨</h4>
                        <p class="text-muted">è·å–æ‰€æœ‰å¯ç”¨çš„MCPèµ„æº</p>
                        <button class="btn btn-primary w-100" onclick="listResources()">
                            ğŸ“š åˆ—å‡ºèµ„æº
                        </button>
                    </div>
                    
                    <div class="test-panel">
                        <h4>æ¨¡å‹ä¿¡æ¯</h4>
                        <p class="text-muted">è·å–å¯ç”¨çš„Demucsæ¨¡å‹åˆ—è¡¨</p>
                        <button class="btn btn-accent w-100" onclick="getModels()">
                            ğŸ¯ è·å–æ¨¡å‹
                        </button>
                    </div>
                </div>
                
                <div class="output-section">
                    <h4>æµ‹è¯•ç»“æœ</h4>
                    <div id="toolsOutput" class="output"></div>
                </div>
            </div>
        </div>

        <!-- éŸ³é¢‘åˆ†ç¦»æµ‹è¯• -->
        <div class="test-section-content" id="audio-section" style="display: none;">
            <div class="card">
                <h2>ğŸµ éŸ³é¢‘åˆ†ç¦»æµ‹è¯•</h2>
                <p>æµ‹è¯•é€šè¿‡MCPåè®®è°ƒç”¨éŸ³é¢‘åˆ†ç¦»åŠŸèƒ½ã€‚</p>
                
                <div class="form-section">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="modelSelect">
                                <span class="label-icon">ğŸ¯</span>
                                æ¨¡å‹é€‰æ‹©
                            </label>
                            <select id="modelSelect" class="form-control">
                                <option value="htdemucs">htdemucs - é»˜è®¤é«˜è´¨é‡</option>
                                <option value="htdemucs_ft">htdemucs_ft - å¾®è°ƒç‰ˆæœ¬</option>
                                <option value="htdemucs_6s">htdemucs_6s - 6éŸ³è½¨ç‰ˆæœ¬</option>
                                <option value="mdx">mdx - å¹³è¡¡å‹</option>
                                <option value="mdx_q">mdx_q - å¿«é€Ÿç‰ˆæœ¬</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <span class="label-icon">ğŸ¼</span>
                                éŸ³è½¨é€‰æ‹©
                            </label>
                            <div class="checkbox-grid">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="vocals" checked>
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¤ äººå£°</span>
                                </label>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="drums">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¥ é¼“ç‚¹</span>
                                </label>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="bass">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¸ è´æ–¯</span>
                                </label>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="other">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¹ å…¶ä»–</span>
                                </label>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="piano">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¹ é’¢ç´</span>
                                </label>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" value="guitar">
                                    <span class="checkmark"></span>
                                    <span class="checkbox-label">ğŸ¸ å‰ä»–</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startAudioSeparation()">
                            ğŸš€ å¼€å§‹æ¨¡æ‹ŸéŸ³é¢‘åˆ†ç¦»
                        </button>
                        <button class="btn btn-danger" onclick="stopStream()">
                            â¹ï¸ åœæ­¢æµ
                        </button>
                        <button class="btn btn-secondary" onclick="clearSeparationOutput()">
                            ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º
                        </button>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-wrapper">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <div id="progressText" class="progress-text">å‡†å¤‡ä¸­...</div>
                    </div>
                </div>
                
                <div class="output-section">
                    <h4>åˆ†ç¦»ç»“æœ</h4>
                    <div id="separationOutput" class="output"></div>
                </div>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-section-content" id="logs-section" style="display: none;">
            <div class="card">
                <h2>ğŸ“œ å®æ—¶æ—¥å¿—ç›‘æ§</h2>
                <p>å®æ—¶æŸ¥çœ‹MCPåè®®é€šä¿¡å’ŒéŸ³é¢‘å¤„ç†çš„è¯¦ç»†æ—¥å¿—ã€‚</p>
                
                <div class="log-controls">
                    <select id="log-level-filter">
                        <option value="all">å…¨éƒ¨çº§åˆ«</option>
                        <option value="debug">DEBUG</option>
                        <option value="info">INFO</option>
                        <option value="warning">WARNING</option>
                        <option value="error">ERROR</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="refreshLogs()">ğŸ”„ åˆ·æ–°</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn btn-success btn-sm" onclick="exportLogs()">ğŸ“„ å¯¼å‡ºæ—¥å¿—</button>
                </div>
                
                <div class="log-container">
                    <div id="logOutput" class="log-viewer"></div>
                </div>
            </div>
        </div>

        <!-- MCPåè®®ä¿¡æ¯ -->
        <div class="card">
            <h2>ğŸ”§ MCPåè®®ä¿¡æ¯</h2>
            <div class="grid grid-2">
                <div class="info-card">
                    <h4>ğŸ“¡ è¿æ¥ä¿¡æ¯</h4>
                    <ul>
                        <li><strong>ç«¯ç‚¹ï¼š</strong> <code>http://localhost:8080/mcp</code></li>
                        <li><strong>åè®®ï¼š</strong> JSON-RPC 2.0</li>
                        <li><strong>ä¼ è¾“ï¼š</strong> HTTP POST</li>
                        <li><strong>æµå¼ï¼š</strong> Server-Sent Events</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h4>ğŸ› ï¸ æ”¯æŒçš„å·¥å…·</h4>
                    <ul>
                        <li><code>separate_audio</code> - éŸ³é¢‘åˆ†ç¦»</li>
                        <li><code>get_models</code> - æ¨¡å‹åˆ—è¡¨</li>
                        <li><code>get_job_status</code> - ä»»åŠ¡çŠ¶æ€</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•ç»Ÿè®¡ -->
        <div class="card">
            <h2>ğŸ“Š æµ‹è¯•ç»Ÿè®¡</h2>
            <div class="grid grid-4">
                <div class="stat-card card-primary">
                    <div class="stat-number" id="tests-run">0</div>
                    <div class="stat-label">å·²è¿è¡Œæµ‹è¯•</div>
                </div>
                <div class="stat-card card-success">
                    <div class="stat-number" id="tests-passed">0</div>
                    <div class="stat-label">æµ‹è¯•é€šè¿‡</div>
                </div>
                <div class="stat-card card-danger">
                    <div class="stat-number" id="tests-failed">0</div>
                    <div class="stat-label">æµ‹è¯•å¤±è´¥</div>
                </div>
                <div class="stat-card card-info">
                    <div class="stat-number" id="avg-response-time">0ms</div>
                    <div class="stat-label">å¹³å‡å“åº”æ—¶é—´</div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>DemucséŸ³é¢‘åˆ†ç¦»å·¥å…· &copy; 2024 | åŸºäº<a href="https://github.com/facebookresearch/demucs" style="color: white; text-decoration: underline;">Demucs</a>å¼€å‘</p>
        </div>
    </footer>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/audio-processor.js') }}"></script>
    <script>
        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            run: 0,
            passed: 0,
            failed: 0,
            responseTimes: []
        };

        // æ˜¾ç¤º/éšè—æµ‹è¯•éƒ¨åˆ†
        function showTestSection(section) {
            // éšè—æ‰€æœ‰æµ‹è¯•éƒ¨åˆ†
            document.querySelectorAll('.test-section-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            document.getElementById(section + '-section').style.display = 'block';
            
            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            event.target.classList.add('active');
        }

        // è®°å½•æµ‹è¯•ç»“æœ
        function recordTestResult(success, responseTime = 0) {
            testStats.run++;
            if (success) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            if (responseTime > 0) {
                testStats.responseTimes.push(responseTime);
            }
            
            updateTestStats();
        }

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡æ˜¾ç¤º
        function updateTestStats() {
            document.getElementById('tests-run').textContent = testStats.run;
            document.getElementById('tests-passed').textContent = testStats.passed;
            document.getElementById('tests-failed').textContent = testStats.failed;
            
            if (testStats.responseTimes.length > 0) {
                const avgTime = testStats.responseTimes.reduce((a, b) => a + b, 0) / testStats.responseTimes.length;
                document.getElementById('avg-response-time').textContent = Math.round(avgTime) + 'ms';
            }
        }

        // æ£€æŸ¥å¥åº·çŠ¶æ€
        async function checkHealth() {
            const startTime = Date.now();
            const output = document.getElementById('healthOutput');
            output.innerHTML = '<div class="loading"><div class="spinner"></div><span>æ­£åœ¨æ£€æŸ¥å¥åº·çŠ¶æ€...</span></div>';
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… æœåŠ¡å™¨å¥åº·æ£€æŸ¥é€šè¿‡</h5>
                        <p><strong>çŠ¶æ€ï¼š</strong> ${data.status}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                        <p><strong>æ—¶é—´æˆ³ï¼š</strong> ${new Date().toLocaleString()}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                document.getElementById('connection-status').textContent = 'æ­£å¸¸';
                recordTestResult(true, responseTime);
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ å¥åº·æ£€æŸ¥å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                    </div>
                `;
                
                document.getElementById('connection-status').textContent = 'å¼‚å¸¸';
                recordTestResult(false, responseTime);
            }
        }

        // è·å–æœåŠ¡å™¨èƒ½åŠ›
        async function getCapabilities() {
            const startTime = Date.now();
            const output = document.getElementById('healthOutput');
            output.innerHTML = '<div class="loading"><div class="spinner"></div><span>æ­£åœ¨è·å–æœåŠ¡å™¨èƒ½åŠ›...</span></div>';
            
            try {
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 1,
                        method: 'initialize',
                        params: {
                            protocolVersion: '1.0',
                            capabilities: {},
                            clientInfo: { name: 'MCP Test Client', version: '1.0.0' }
                        }
                    })
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… æœåŠ¡å™¨èƒ½åŠ›è·å–æˆåŠŸ</h5>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                recordTestResult(true, responseTime);
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ è·å–æœåŠ¡å™¨èƒ½åŠ›å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                    </div>
                `;
                
                recordTestResult(false, responseTime);
            }
        }

        // åˆ—å‡ºå·¥å…·
        async function listTools() {
            const startTime = Date.now();
            const output = document.getElementById('toolsOutput');
            output.innerHTML = '<div class="loading"><div class="spinner"></div><span>æ­£åœ¨è·å–å·¥å…·åˆ—è¡¨...</span></div>';
            
            try {
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 2,
                        method: 'tools/list',
                        params: {}
                    })
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                if (data.result && data.result.tools) {
                    document.getElementById('tools-count').textContent = data.result.tools.length;
                }
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… å·¥å…·åˆ—è¡¨è·å–æˆåŠŸ</h5>
                        <p><strong>å·¥å…·æ•°é‡ï¼š</strong> ${data.result?.tools?.length || 0}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                recordTestResult(true, responseTime);
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ è·å–å·¥å…·åˆ—è¡¨å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                    </div>
                `;
                
                recordTestResult(false, responseTime);
            }
        }

        // åˆ—å‡ºèµ„æº
        async function listResources() {
            const startTime = Date.now();
            const output = document.getElementById('toolsOutput');
            
            try {
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 3,
                        method: 'resources/list',
                        params: {}
                    })
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                if (data.result && data.result.resources) {
                    document.getElementById('resources-count').textContent = data.result.resources.length;
                }
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… èµ„æºåˆ—è¡¨è·å–æˆåŠŸ</h5>
                        <p><strong>èµ„æºæ•°é‡ï¼š</strong> ${data.result?.resources?.length || 0}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                recordTestResult(true, responseTime);
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ è·å–èµ„æºåˆ—è¡¨å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                    </div>
                `;
                
                recordTestResult(false, responseTime);
            }
        }

        // è·å–æ¨¡å‹
        async function getModels() {
            const startTime = Date.now();
            const output = document.getElementById('toolsOutput');
            
            try {
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 4,
                        method: 'tools/call',
                        params: {
                            name: 'get_models',
                            arguments: {}
                        }
                    })
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… æ¨¡å‹åˆ—è¡¨è·å–æˆåŠŸ</h5>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                recordTestResult(true, responseTime);
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                        <p><strong>å“åº”æ—¶é—´ï¼š</strong> ${responseTime}ms</p>
                    </div>
                `;
                
                recordTestResult(false, responseTime);
            }
        }

        // å¼€å§‹éŸ³é¢‘åˆ†ç¦»
        async function startAudioSeparation() {
            const model = document.getElementById('modelSelect').value;
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const stems = Array.from(checkboxes).map(cb => cb.value);
            
            if (stems.length === 0) {
                window.showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªéŸ³è½¨ç±»å‹', 'warning');
                return;
            }
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const output = document.getElementById('separationOutput');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'æ­£åœ¨å¯åŠ¨éŸ³é¢‘åˆ†ç¦»...';
            
            try {
                const response = await fetch('/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 5,
                        method: 'tools/call',
                        params: {
                            name: 'separate_audio',
                            arguments: {
                                file_path: '/demo/test_audio.mp3',
                                model: model,
                                stems: stems,
                                stream_progress: true
                            }
                        }
                    })
                });
                
                const data = await response.json();
                
                output.innerHTML = `
                    <div class="result-success">
                        <h5>âœ… éŸ³é¢‘åˆ†ç¦»ä»»åŠ¡å¯åŠ¨æˆåŠŸ</h5>
                        <p><strong>ä»»åŠ¡IDï¼š</strong> ${data.result?.job_id || 'N/A'}</p>
                        <p><strong>æ¨¡å‹ï¼š</strong> ${model}</p>
                        <p><strong>éŸ³è½¨ï¼š</strong> ${stems.join(', ')}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                simulateProgress();
                recordTestResult(true);
                
            } catch (error) {
                output.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ éŸ³é¢‘åˆ†ç¦»å¯åŠ¨å¤±è´¥</h5>
                        <p><strong>é”™è¯¯ï¼š</strong> ${error.message}</p>
                    </div>
                `;
                
                progressContainer.style.display = 'none';
                recordTestResult(false);
            }
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    progressText.textContent = 'âœ… åˆ†ç¦»å®Œæˆï¼';
                } else {
                    progressText.textContent = `å¤„ç†ä¸­... ${Math.round(progress)}%`;
                }
                
                progressFill.style.width = progress + '%';
            }, 500);
        }

        // åœæ­¢æµ
        function stopStream() {
            document.getElementById('progressContainer').style.display = 'none';
            window.showMessage('å·²åœæ­¢éŸ³é¢‘åˆ†ç¦»æµ', 'info');
        }

        // æ¸…ç©ºåˆ†ç¦»è¾“å‡º
        function clearSeparationOutput() {
            document.getElementById('separationOutput').innerHTML = '';
            document.getElementById('progressContainer').style.display = 'none';
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
            window.showMessage('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = `
                <div class="log-entry log-info">
                    <span class="log-time">[${new Date().toLocaleTimeString()}]</span>
                    <span class="log-level">INFO</span>
                    <span class="log-message">æ—¥å¿—å·²åˆ·æ–°</span>
                </div>
            `;
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logs = document.getElementById('logOutput').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mcp-test-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            window.showMessage('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
            setTimeout(checkHealth, 1000);
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°è¿æ¥çŠ¶æ€
            setInterval(async () => {
                try {
                    const response = await fetch('/health');
                    if (response.ok) {
                        document.getElementById('connection-status').textContent = 'æ­£å¸¸';
                    } else {
                        document.getElementById('connection-status').textContent = 'å¼‚å¸¸';
                    }
                } catch (error) {
                    document.getElementById('connection-status').textContent = 'æ–­å¼€';
                }
            }, 30000);
        });
    </script>
</body>
</html> 