<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demucs éŸ³é¢‘åˆ†ç¦»å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸµ Demucs éŸ³é¢‘åˆ†ç¦»å·¥å…·</h1>
            <p>åŸºäºæ·±åº¦å­¦ä¹ çš„é«˜è´¨é‡éŸ³é¢‘æºåˆ†ç¦»ç³»ç»Ÿï¼Œå®Œå…¨æ”¯æŒæ ‡å‡† <strong>MCP (Model Context Protocol)</strong> åè®®</p>
            <div class="main-nav">
                <a href="/" class="nav-link active">ğŸ  é¦–é¡µ</a>
                <a href="/mcp" class="nav-link">ğŸ”— MCPåè®®</a>
                <a href="/api-docs" class="nav-link">ğŸ“š APIæ–‡æ¡£</a>
                <a href="/docs" class="nav-link">ğŸ“– ä½¿ç”¨æŒ‡å—</a>
                <a href="/test-guide" class="nav-link">ğŸ§ª æµ‹è¯•æŒ‡å—</a>
                <a href="/admin" class="nav-link">ğŸ› ï¸ ç®¡ç†é¢æ¿</a>
            </div>
        </div>
    </header>
    
    <div class="container container-sm">
        <!-- å¿«é€Ÿå¯¼èˆªåŒºåŸŸ -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="color: white; margin-top: 0;">ğŸš€ å¿«é€Ÿå¼€å§‹</h3>
            <p>é€‰æ‹©æ‚¨éœ€è¦çš„åŠŸèƒ½ï¼š</p>
            <div class="grid grid-2">
                <a href="#upload-form" class="nav-link" style="background: rgba(255, 255, 255, 0.2);">
                    ğŸµ å¼€å§‹åˆ†ç¦»éŸ³é¢‘
                </a>
                <a href="/test/mcp" class="nav-link" style="background: rgba(255, 255, 255, 0.2);">
                    ğŸ§ª æµ‹è¯•MCPåŠŸèƒ½
                </a>
                <a href="/api-docs" class="nav-link" style="background: rgba(255, 255, 255, 0.2);">
                    ğŸ“š æŸ¥çœ‹APIæ–‡æ¡£
                </a>
                <a href="/docs" class="nav-link" style="background: rgba(255, 255, 255, 0.2);">
                    ğŸ“– é˜…è¯»ä½¿ç”¨æŒ‡å—
                </a>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½ä»‹ç» -->
        <div class="card">
            <h2>âœ¨ åŠŸèƒ½ç‰¹è‰²</h2>
            <div class="grid">
                <div class="card" style="text-align: center; border-top: 4px solid var(--primary-color);">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ¯</div>
                    <h3>é«˜ç²¾åº¦åˆ†ç¦»</h3>
                    <p>åŸºäºæœ€æ–°çš„Demucsæ¨¡å‹ï¼Œæä¾›ä¸“ä¸šçº§çš„éŸ³é¢‘æºåˆ†ç¦»è´¨é‡</p>
                </div>
                <div class="card" style="text-align: center; border-top: 4px solid var(--primary-color);">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ”—</div>
                    <h3>MCPåè®®æ”¯æŒ</h3>
                    <p>å®Œå…¨å…¼å®¹æ ‡å‡†MCPåè®®ï¼Œå¯ä¸Claude Desktopç­‰å·¥å…·é›†æˆ</p>
                </div>
                <div class="card" style="text-align: center; border-top: 4px solid var(--primary-color);">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">âš¡</div>
                    <h3>å®æ—¶è¿›åº¦</h3>
                    <p>é€šè¿‡SSEå’ŒMCPæä¾›å®æ—¶å¤„ç†è¿›åº¦åé¦ˆ</p>
                </div>
                <div class="card" style="text-align: center; border-top: 4px solid var(--primary-color);">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">ğŸ›ï¸</div>
                    <h3>å¤šæ ¼å¼æ”¯æŒ</h3>
                    <p>æ”¯æŒWAVã€MP3ã€FLACç­‰å¤šç§è¾“å‡ºæ ¼å¼å’Œè´¨é‡é€‰é¡¹</p>
                </div>
            </div>
        </div>
        
        <!-- éŸ³é¢‘åˆ†ç¦»è¡¨å• -->
        <form id="audioForm" class="card">
            <h2 id="upload-form">ğŸµ éŸ³é¢‘åˆ†ç¦»å·¥å…·</h2>
            <p>ä¸Šä¼ æ‚¨çš„éŸ³é¢‘æ–‡ä»¶ï¼Œé€‰æ‹©æ¨¡å‹å’Œå‚æ•°ï¼Œç„¶åå¼€å§‹åˆ†ç¦»å¤„ç†ã€‚</p>
            
            <div class="upload-area" id="dropArea">
                <p>å°†éŸ³é¢‘æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="audioFile" name="file" accept=".mp3,.wav,.flac,.ogg,.m4a" style="display: none;">
            </div>
            
            <div id="fileInfo"></div>
            
            <div class="form-group">
                <label for="model">åˆ†ç¦»æ¨¡å‹ï¼š</label>
                <select id="model" name="model" disabled>
                    <option value="htdemucs" selected>htdemucs (é»˜è®¤æ¨¡å‹ï¼ŒèŠ‚çœæœåŠ¡å™¨èµ„æº)</option>
                </select>
                <p><small>ğŸ› ï¸ ä¸ºèŠ‚çœæœåŠ¡å™¨èµ„æºï¼Œå½“å‰åªæ”¯æŒé»˜è®¤æ¨¡å‹</small></p>
            </div>
            
            <div class="form-group">
                <label for="stems">æå–éŸ³è½¨ï¼š</label>
                <select id="stems" name="stems" multiple>
                    <option value="vocals" selected>äººå£° (Vocals)</option>
                    <option value="drums" selected>é¼“ç‚¹ (Drums)</option>
                    <option value="bass" selected>è´æ–¯ (Bass)</option>
                    <option value="other" selected>å…¶ä»–ä¹å™¨ (Other)</option>
                    <option value="piano">é’¢ç´ (Pianoï¼Œä»…htdemucs_6sæ”¯æŒ)</option>
                    <option value="guitar">å‰ä»– (Guitarï¼Œä»…htdemucs_6sæ”¯æŒ)</option>
                </select>
                <p><small>æŒ‰ä½Ctrlé”®(Macä¸Šä¸ºCommandé”®)å¯é€‰æ‹©å¤šä¸ªéŸ³è½¨</small></p>
            </div>
            
            <div class="form-group">
                <label for="outputFormat">è¾“å‡ºæ ¼å¼ï¼š</label>
                <select id="outputFormat" name="output_format" disabled>
                    <option value="mp3" selected>MP3 (æœ‰æŸå‹ç¼©ï¼Œä½“ç§¯å°)</option>
                </select>
                <p><small>ğŸ› ï¸ ä¸ºèŠ‚çœæœåŠ¡å™¨èµ„æºï¼Œå½“å‰åªæ”¯æŒMP3æ ¼å¼</small></p>
            </div>
            
            <div class="form-group">
                <label for="audioQuality">éŸ³é¢‘è´¨é‡ï¼š</label>
                <select id="audioQuality" name="audio_quality" disabled>
                    <option value="low" selected>ä½è´¨é‡ (128kbps, 22kHz)</option>
                </select>
                <p><small id="qualityDescription">ğŸ› ï¸ ä¸ºèŠ‚çœæœåŠ¡å™¨èµ„æºï¼Œå½“å‰åªæ”¯æŒä½è´¨é‡è¾“å‡º</small></p>
            </div>
            
            <div class="form-group">
                <button type="submit" id="processBtn" class="btn btn-primary btn-lg w-100">å¼€å§‹åˆ†ç¦»</button>
                <button type="button" id="stopBtn" class="btn btn-danger ml-2" style="display: none;">åœæ­¢å¤„ç†</button>
            </div>
        </form>
        
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="card">
                <h3>å¤„ç†ä¸­...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
        
        <div id="jobInfo"></div>
        <div id="results" style="display: none;"></div>
        
        <!-- APIä½¿ç”¨æŒ‡å— -->
        <div class="card">
            <h2>ğŸ”§ APIä½¿ç”¨</h2>
            <p>æœ¬æœåŠ¡åŒæ—¶æä¾›REST APIå’ŒMCPåè®®æ¥å£ï¼Œæ”¯æŒç¨‹åºåŒ–è°ƒç”¨ï¼š</p>
            <h3>å¿«é€Ÿæµ‹è¯•</h3>
            <pre><code># REST API
curl -X POST http://localhost:8080/api/process \
  -F "audio=@your_audio.mp3" \
  -F "model=htdemucs" \
  -F "stems=vocals,drums" \
  -F "output_format=wav" \
  -F "audio_quality=high"

# MCPåè®® (JSON-RPC 2.0)
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "separate_audio",
    "arguments": {
      "file_path": "/path/to/audio.mp3",
      "model": "htdemucs",
      "stems": ["vocals", "drums"]
    }
  }
}</code></pre>
            
            <p class="text-center mt-3">
                <a href="/api-docs" class="btn btn-primary">æŸ¥çœ‹å®Œæ•´APIæ–‡æ¡£</a>
                <a href="/test/mcp" class="btn btn-accent ml-2">æµ‹è¯•MCPåŠŸèƒ½</a>
            </p>
        </div>
    </div>
    
    <footer class="text-center p-4" style="background-color: var(--secondary-color); color: white; margin-top: 40px;">
        <p>&copy; 2024 Demucs éŸ³é¢‘åˆ†ç¦»å·¥å…·. åŸºäº <a href="https://github.com/facebookresearch/demucs" style="color: #87ceeb;">Facebook Demucs</a> å¼€å‘</p>
    </footer>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/audio-processor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/debug.js') }}"></script>
    
    <script>
        // åˆå§‹åŒ–éŸ³é¢‘å¤„ç†å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–éŸ³é¢‘å¤„ç†å™¨');
            
            // æ£€æŸ¥éŸ³é¢‘å¤„ç†å™¨æ˜¯å¦å¯ç”¨
            if (window.AudioProcessor) {
                window.AudioProcessor.init();
                console.log('âœ… éŸ³é¢‘å¤„ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                
                // æ·»åŠ è°ƒè¯•åŠŸèƒ½
                if (location.search.includes('debug=1')) {
                    addDebugControls();
                }
            } else {
                console.error('âŒ éŸ³é¢‘å¤„ç†å™¨æœªæ‰¾åˆ°');
            }
            
            // æ·»åŠ è´¨é‡é€‰æ‹©å˜åŒ–ç›‘å¬
            const qualitySelect = document.getElementById('audioQuality');
            const qualityDescription = document.getElementById('qualityDescription');
            
            if (qualitySelect && qualityDescription) {
                qualitySelect.addEventListener('change', function() {
                    const descriptions = {
                        'high': 'è´¨é‡è¶Šé«˜ï¼Œæ–‡ä»¶è¶Šå¤§ä½†éŸ³è´¨è¶Šå¥½',
                        'medium': 'å¹³è¡¡æ–‡ä»¶å¤§å°å’ŒéŸ³è´¨ï¼Œé€‚åˆå¤§å¤šæ•°ç”¨é€”',
                        'low': 'æ–‡ä»¶æœ€å°ï¼ŒéŸ³è´¨ä¸€èˆ¬ï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆ',
                        'lossless': 'æœ€é«˜éŸ³è´¨ï¼Œæ— æŸå‹ç¼©ï¼Œæ–‡ä»¶è¾ƒå¤§'
                    };
                    qualityDescription.textContent = descriptions[this.value] || 'è¯·é€‰æ‹©éŸ³é¢‘è´¨é‡';
                });
            }
        });
        
        // è°ƒè¯•åŠŸèƒ½
        function addDebugControls() {
            const debugPanel = document.createElement('div');
            debugPanel.innerHTML = `
                <div style="position: fixed; top: 10px; right: 10px; background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 5px; z-index: 1000; max-width: 300px;">
                    <h5>ğŸ› è°ƒè¯•é¢æ¿</h5>
                    <button onclick="testCurrentTask()" class="btn btn-sm btn-primary">æµ‹è¯•å½“å‰ä»»åŠ¡</button>
                    <button onclick="testMockCompletion()" class="btn btn-sm btn-success">æµ‹è¯•æ¨¡æ‹Ÿå®Œæˆ</button>
                    <button onclick="clearResults()" class="btn btn-sm btn-secondary">æ¸…ç©ºç»“æœ</button>
                    <div id="debugOutput" style="margin-top: 10px; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                </div>
            `;
            document.body.appendChild(debugPanel);
        }
        
        // æµ‹è¯•å½“å‰ä»»åŠ¡
        async function testCurrentTask() {
            const jobId = '0a5dbedc-f4e8-459c-a606-16c47001ea76'; // ä½¿ç”¨å½“å‰ä»»åŠ¡ID
            debugLog('æ­£åœ¨æ£€æŸ¥ä»»åŠ¡: ' + jobId);
            
            try {
                const response = await fetch('/api/status/' + jobId);
                const result = await response.json();
                debugLog('APIå“åº”: ' + JSON.stringify(result));
                
                if (result.status === 'success') {
                    debugLog('è°ƒç”¨showResults...');
                    window.AudioProcessor.showResults(result.data);
                } else {
                    debugLog('ä»»åŠ¡æœªæ‰¾åˆ°æˆ–æœªå®Œæˆ');
                }
            } catch (error) {
                debugLog('é”™è¯¯: ' + error.message);
            }
        }
        
        // æµ‹è¯•æ¨¡æ‹Ÿå®ŒæˆçŠ¶æ€
        function testMockCompletion() {
            debugLog('æµ‹è¯•æ¨¡æ‹Ÿå®ŒæˆçŠ¶æ€...');
            const mockData = {
                job_id: '0a5dbedc-f4e8-459c-a606-16c47001ea76',
                progress: 100,
                status: 'completed',
                message: 'éŸ³é¢‘åˆ†ç¦»å®Œæˆï¼Œæ ¼å¼: MP3ï¼Œè´¨é‡: low',
                result_file: '/path/to/result.zip'
            };
            
            debugLog('è°ƒç”¨showResults: ' + JSON.stringify(mockData));
            window.AudioProcessor.showResults(mockData);
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResults() {
            const results = document.getElementById('results');
            if (results) {
                results.style.display = 'none';
                results.innerHTML = '';
                debugLog('ç»“æœå·²æ¸…ç©º');
            }
        }
        
        // è°ƒè¯•æ—¥å¿—
        function debugLog(message) {
            console.log('[DEBUG]', message);
            const output = document.getElementById('debugOutput');
            if (output) {
                output.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
                output.scrollTop = output.scrollHeight;
            }
        }
    </script>
</body>
</html> 