<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¢æ¿ - Demucs éŸ³é¢‘åˆ†ç¦»å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-flex">
                <h1>ğŸ› ï¸ ç®¡ç†é¢æ¿</h1>
                <div class="header-actions">
                    <a href="/" class="btn btn-secondary">ğŸ  è¿”å›é¦–é¡µ</a>
                    <a href="/admin/logout" class="btn btn-outline">ğŸšª é€€å‡ºç™»å½•</a>
                </div>
            </div>
            <div class="main-nav">
                <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
                <a href="/mcp" class="nav-link">ğŸ”— MCPåè®®</a>
                <a href="/api-docs" class="nav-link">ğŸ“š APIæ–‡æ¡£</a>
                <a href="/docs" class="nav-link">ğŸ“– ä½¿ç”¨æŒ‡å—</a>
                <a href="/test-guide" class="nav-link">ğŸ§ª æµ‹è¯•æŒ‡å—</a>
                <a href="/admin" class="nav-link active">ğŸ› ï¸ ç®¡ç†é¢æ¿</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="card">
            <h2>ğŸ“Š ç³»ç»Ÿç»Ÿè®¡</h2>
            <div class="grid grid-4">
                <div class="stat-card card-primary">
                    <div class="stat-number" id="total-tasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                </div>
                <div class="stat-card card-success">
                    <div class="stat-number" id="completed-tasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card card-warning">
                    <div class="stat-number" id="processing-tasks">0</div>
                    <div class="stat-label">å¤„ç†ä¸­</div>
                </div>
                <div class="stat-card card-danger">
                    <div class="stat-number" id="old-tasks">0</div>
                    <div class="stat-label">è¿‡æœŸä»»åŠ¡</div>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card">
            <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-success" onclick="downloadSystemInfo()">ğŸ“Š å¯¼å‡ºç»Ÿè®¡</button>
                <button class="btn btn-warning" onclick="cleanupOldFiles()">ğŸ§¹ æ¸…ç†è¿‡æœŸæ–‡ä»¶</button>
                <button class="btn btn-danger" onclick="cleanupAllFiles()">ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰æ–‡ä»¶</button>
            </div>
        </div>

        <!-- æœåŠ¡å™¨çŠ¶æ€ -->
        <div class="card">
            <h2>ğŸ’» æœåŠ¡å™¨çŠ¶æ€</h2>
            <div class="grid grid-2">
                <div class="card" style="background: #f8f9fa;">
                    <h4>ç³»ç»Ÿä¿¡æ¯</h4>
                    <div id="system-info">
                        <p>CPUä½¿ç”¨ç‡: <span id="cpu-usage" class="badge">æ£€æŸ¥ä¸­...</span></p>
                        <p>å†…å­˜ä½¿ç”¨: <span id="memory-usage" class="badge">æ£€æŸ¥ä¸­...</span></p>
                        <p>ç£ç›˜ç©ºé—´: <span id="disk-usage" class="badge">æ£€æŸ¥ä¸­...</span></p>
                        <p>è¿è¡Œæ—¶é—´: <span id="uptime" class="badge">æ£€æŸ¥ä¸­...</span></p>
                    </div>
                </div>
                <div class="card" style="background: #f8f9fa;">
                    <h4>æœåŠ¡çŠ¶æ€</h4>
                    <div id="service-status">
                        <p>WebæœåŠ¡: <span id="web-status" class="badge badge-success">æ­£å¸¸</span></p>
                        <p>å¤„ç†æœåŠ¡: <span id="process-status" class="badge">æ£€æŸ¥ä¸­...</span></p>
                        <p>æ–‡ä»¶æœåŠ¡: <span id="file-status" class="badge">æ£€æŸ¥ä¸­...</span></p>
                        <p>æ•°æ®åº“: <span id="db-status" class="badge">æ£€æŸ¥ä¸­...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“‹ ä»»åŠ¡ç®¡ç†</h2>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label>çŠ¶æ€ç­›é€‰:</label>
                    <select id="status-filter" onchange="filterTasks()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="processing">å¤„ç†ä¸­</option>
                        <option value="failed">å¤±è´¥</option>
                        <option value="old">è¿‡æœŸ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ—¶é—´èŒƒå›´:</label>
                    <select id="time-filter" onchange="filterTasks()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="search-input" placeholder="æœç´¢ä»»åŠ¡IDæˆ–æ–‡ä»¶å..." onkeyup="searchTasks()">
                </div>
            </div>

            <div class="table-container">
                <table class="table" id="tasks-table">
                    <thead>
                        <tr>
                            <th>ä»»åŠ¡ID</th>
                            <th>çŠ¶æ€</th>
                            <th>è¾“å…¥æ–‡ä»¶</th>
                            <th>è¾“å‡ºæ–‡ä»¶</th>
                            <th>æ–‡ä»¶å¤§å°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-body">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>æ­£åœ¨åŠ è½½ä»»åŠ¡æ•°æ®...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å­¤ç«‹æ–‡ä»¶ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“„ å­¤ç«‹æ–‡ä»¶ç®¡ç†</h2>
            <p class="text-muted">è¿™äº›æ–‡ä»¶æ²¡æœ‰å¯¹åº”çš„ä»»åŠ¡è®°å½•ï¼Œå¯èƒ½æ˜¯å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚</p>
            
            <div class="orphaned-files" id="orphaned-files">
                <div class="text-center">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>æ­£åœ¨æ‰«æå­¤ç«‹æ–‡ä»¶...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹ -->
        <div class="card">
            <h2>ğŸ“œ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="log-controls">
                <select id="log-level">
                    <option value="all">å…¨éƒ¨çº§åˆ«</option>
                    <option value="error">é”™è¯¯</option>
                    <option value="warning">è­¦å‘Š</option>
                    <option value="info">ä¿¡æ¯</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="refreshLogs()">åˆ·æ–°æ—¥å¿—</button>
                <button class="btn btn-secondary btn-sm" onclick="clearLogs()">æ¸…ç©ºæ˜¾ç¤º</button>
            </div>
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="log-time">[ç³»ç»Ÿå¯åŠ¨]</span>
                    <span class="log-level log-info">INFO</span>
                    <span class="log-message">ç®¡ç†é¢æ¿åŠ è½½å®Œæˆ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡åŠå…¶æ‰€æœ‰ç›¸å…³æ–‡ä»¶å—ï¼Ÿ</p>
                <p class="text-danger"><strong>æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼</strong></p>
                <div id="delete-task-info"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3>ğŸ“‹ ä»»åŠ¡è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeTaskDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="task-details-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>æ­£åœ¨åŠ è½½ä»»åŠ¡è¯¦æƒ…...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTaskDetailsModal()">å…³é—­</button>
                <button class="btn btn-primary" onclick="downloadTaskResults()" id="download-task-btn" style="display: none;">ğŸ“¥ ä¸‹è½½è¾“å‡ºæ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ¨¡æ€æ¡† -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¦ æ‰¹é‡æ“ä½œ</h3>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>é€‰æ‹©è¦æ‰§è¡Œçš„æ‰¹é‡æ“ä½œï¼š</p>
                <div class="batch-options">
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-old">
                        <span>åˆ é™¤è¿‡æœŸä»»åŠ¡ï¼ˆè¶…è¿‡7å¤©ï¼‰</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-failed">
                        <span>åˆ é™¤å¤±è´¥ä»»åŠ¡</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-all">
                        <span>åˆ é™¤æ‰€æœ‰ä»»åŠ¡</span>
                    </label>
                </div>
                <div id="batch-preview" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBatchModal()">å–æ¶ˆ</button>
                <button class="btn btn-warning" onclick="executeBatchAction()">æ‰§è¡Œæ“ä½œ</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>DemucséŸ³é¢‘åˆ†ç¦»å·¥å…·ç®¡ç†é¢æ¿ &copy; 2024</p>
        </div>
    </footer>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // å…¨å±€å˜é‡
        let allTasks = [];
        let filteredTasks = [];
        let deleteTaskId = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
        });

        // åˆå§‹åŒ–ç®¡ç†é¢æ¿
        async function initializeAdmin() {
            await refreshData();
            startStatusPolling();
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            window.showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            
            try {
                // è·å–ä»»åŠ¡æ•°æ®
                const response = await fetch('/admin/api/files');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        updateStatistics(data.data.summary);
                        updateTasksTable(data.data.tasks);
                        updateOrphanedFiles(data.data.orphaned_files);
                        allTasks = data.data.tasks;
                        filteredTasks = [...allTasks];
                        window.showMessage('æ•°æ®åˆ·æ–°æˆåŠŸ', 'success');
                    }
                }
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                window.showMessage('æ•°æ®åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics(summary) {
            document.getElementById('total-tasks').textContent = summary.total_tasks;
            document.getElementById('completed-tasks').textContent = summary.completed_tasks;
            document.getElementById('processing-tasks').textContent = summary.processing_tasks;
            document.getElementById('old-tasks').textContent = summary.old_tasks;
            
            // æ·»åŠ æ‰«ææ€§èƒ½ä¿¡æ¯æ˜¾ç¤º
            if (summary.scan_duration !== undefined) {
                const scanInfo = document.getElementById('scan-info');
                if (!scanInfo) {
                    // åˆ›å»ºæ‰«æä¿¡æ¯å…ƒç´ 
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'scan-info';
                    infoDiv.className = 'scan-performance-info mt-2';
                    infoDiv.innerHTML = `
                        <small class="text-muted">
                            ğŸ“Š æ‰«æè€—æ—¶: <span id="scan-duration">${summary.scan_duration.toFixed(2)}ç§’</span> | 
                            æ‰«ææ–‡ä»¶: <span id="scan-files">${summary.scanned_files}</span>ä¸ª
                            ${summary.scan_limited ? ' <span class="badge badge-warning">å·²é™åˆ¶</span>' : ''}
                            ${summary.tasks_truncated ? ' <span class="badge badge-info">ä»»åŠ¡å·²æˆªæ–­</span>' : ''}
                        </small>
                    `;
                    document.querySelector('.grid-4').after(infoDiv);
                } else {
                    // æ›´æ–°ç°æœ‰ä¿¡æ¯
                    document.getElementById('scan-duration').textContent = `${summary.scan_duration.toFixed(2)}ç§’`;
                    document.getElementById('scan-files').textContent = summary.scanned_files;
                }
            }
        }

        // æ›´æ–°ä»»åŠ¡è¡¨æ ¼
        function updateTasksTable(tasks) {
            const tbody = document.getElementById('tasks-body');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">æš‚æ— ä»»åŠ¡æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => `
                <tr class="task-row ${task.is_old ? 'task-old' : ''}" data-task-id="${task.task_id}">
                    <td>
                        <code>${task.task_id.substring(0, 8)}...</code>
                        ${task.is_old ? '<span class="badge badge-warning">è¿‡æœŸ</span>' : ''}
                    </td>
                    <td>
                        <span class="badge badge-${getStatusColor(task.status)}">${getStatusText(task.status)}</span>
                    </td>
                    <td>${task.input_files.length} ä¸ªæ–‡ä»¶</td>
                    <td>${task.output_files.length} ä¸ªæ–‡ä»¶</td>
                    <td>${formatFileSize(task.total_size)}</td>
                    <td>${formatDateTime(task.created_time)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="viewTaskDetails('${task.task_id}')">
                                ğŸ“‹ è¯¦æƒ…
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.task_id}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°å­¤ç«‹æ–‡ä»¶
        function updateOrphanedFiles(orphanedFiles) {
            const container = document.getElementById('orphaned-files');
            
            if (orphanedFiles.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°å­¤ç«‹æ–‡ä»¶</p>';
                return;
            }

            container.innerHTML = `
                <div class="orphaned-header">
                    <p>æ‰¾åˆ° ${orphanedFiles.length} ä¸ªå­¤ç«‹æ–‡ä»¶ï¼š</p>
                    <button class="btn btn-warning btn-sm" onclick="cleanupOrphanedFiles()">
                        ğŸ§¹ æ¸…ç†æ‰€æœ‰å­¤ç«‹æ–‡ä»¶
                    </button>
                </div>
                <div class="orphaned-list">
                    ${orphanedFiles.map(file => `
                        <div class="orphaned-item">
                            <span class="file-name">${file.name}</span>
                            <span class="file-type badge">${file.type}</span>
                            <span class="file-size">${formatFileSize(file.size)}</span>
                            <button class="btn btn-sm btn-danger" onclick="deleteOrphanedFile('${file.path}')">
                                åˆ é™¤
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // è·å–çŠ¶æ€é¢œè‰²
        function getStatusColor(status) {
            const colors = {
                'completed': 'success',
                'processing': 'warning',
                'failed': 'danger',
                'pending': 'info'
            };
            return colors[status] || 'secondary';
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const texts = {
                'completed': 'å·²å®Œæˆ',
                'processing': 'å¤„ç†ä¸­',
                'failed': 'å¤±è´¥',
                'pending': 'ç­‰å¾…ä¸­'
            };
            return texts[status] || status;
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            deleteTaskId = taskId;
            const task = allTasks.find(t => t.task_id === taskId);
            if (task) {
                document.getElementById('delete-task-info').innerHTML = `
                    <div class="task-info">
                        <p><strong>ä»»åŠ¡ID:</strong> ${taskId}</p>
                        <p><strong>è¾“å…¥æ–‡ä»¶:</strong> ${task.input_files.length} ä¸ª</p>
                        <p><strong>è¾“å‡ºæ–‡ä»¶:</strong> ${task.output_files.length} ä¸ª</p>
                        <p><strong>æ€»å¤§å°:</strong> ${formatFileSize(task.total_size)}</p>
                    </div>
                `;
            }
            // ä¿®å¤å¼¹çª—æ˜¾ç¤ºé€»è¾‘
            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­åŠŸèƒ½
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeDeleteModal();
                }
            };
        }

        // ç¡®è®¤åˆ é™¤
        async function confirmDelete() {
            if (!deleteTaskId) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const confirmBtn = document.querySelector('#delete-modal .btn-danger');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = 'åˆ é™¤ä¸­...';
            confirmBtn.disabled = true;

            try {
                const response = await fetch('/admin/api/tasks/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_id: deleteTaskId })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }

            closeDeleteModal();
        }

        // å…³é—­åˆ é™¤æ¨¡æ€æ¡†
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                deleteTaskId = null;
            }, 300);
        }

        // æ¸…ç†è¿‡æœŸæ–‡ä»¶
        async function cleanupOldFiles() {
            // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
            const confirmed = await showConfirmDialog(
                'æ¸…ç†è¿‡æœŸæ–‡ä»¶',
                'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰è¿‡æœŸæ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„æ‰€æœ‰æ–‡ä»¶ã€‚',
                'æ¸…ç†',
                'warning'
            );
            
            if (!confirmed) return;

            try {
                window.showMessage('æ­£åœ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶...', 'info');
                const response = await fetch('/admin/api/cleanup/old', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç†æ‰€æœ‰æ–‡ä»¶
        async function cleanupAllFiles() {
            const confirmed = await showConfirmDialog(
                'âš ï¸ å±é™©æ“ä½œ',
                'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä¸Šä¼ å’Œè¾“å‡ºæ–‡ä»¶ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼',
                'ç¡®è®¤æ¸…ç†',
                'danger'
            );
            
            if (!confirmed) return;

            try {
                window.showMessage('æ­£åœ¨æ¸…ç†æ‰€æœ‰æ–‡ä»¶...', 'info');
                const response = await fetch('/admin/api/cleanup/all', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, confirmText = 'ç¡®è®¤', type = 'warning') {
            return new Promise((resolve) => {
                // åˆ›å»ºå¯¹è¯æ¡†HTML
                const dialogHtml = `
                    <div id="custom-confirm-modal" class="modal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${title}</h3>
                                <button class="modal-close" onclick="closeCustomConfirm(false)">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeCustomConfirm(false)">å–æ¶ˆ</button>
                                <button class="btn btn-${type}" onclick="closeCustomConfirm(true)">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.insertAdjacentHTML('beforeend', dialogHtml);
                
                // è®¾ç½®å…¨å±€å›è°ƒ
                window.customConfirmResolve = resolve;
            });
        }

        // å…³é—­è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function closeCustomConfirm(result) {
            const modal = document.getElementById('custom-confirm-modal');
            if (modal) {
                modal.remove();
            }
            if (window.customConfirmResolve) {
                window.customConfirmResolve(result);
                delete window.customConfirmResolve;
            }
        }

        // ä¸‹è½½ç³»ç»Ÿä¿¡æ¯
        function downloadSystemInfo() {
            const data = {
                timestamp: new Date().toISOString(),
                statistics: {
                    total_tasks: document.getElementById('total-tasks').textContent,
                    completed_tasks: document.getElementById('completed-tasks').textContent,
                    processing_tasks: document.getElementById('processing-tasks').textContent,
                    old_tasks: document.getElementById('old-tasks').textContent
                },
                tasks: allTasks
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demucs-admin-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            window.showMessage('ç³»ç»Ÿä¿¡æ¯å·²å¯¼å‡º', 'success');
        }

        // ç­›é€‰ä»»åŠ¡
        function filterTasks() {
            const statusFilter = document.getElementById('status-filter').value;
            const timeFilter = document.getElementById('time-filter').value;

            filteredTasks = allTasks.filter(task => {
                // çŠ¶æ€ç­›é€‰
                if (statusFilter !== 'all') {
                    if (statusFilter === 'old' && !task.is_old) return false;
                    if (statusFilter !== 'old' && task.status !== statusFilter) return false;
                }

                // æ—¶é—´ç­›é€‰
                if (timeFilter !== 'all') {
                    const now = Date.now() / 1000;
                    const taskTime = task.created_time;
                    const timeDiff = now - taskTime;

                    switch (timeFilter) {
                        case 'today':
                            if (timeDiff > 24 * 3600) return false;
                            break;
                        case 'week':
                            if (timeDiff > 7 * 24 * 3600) return false;
                            break;
                        case 'month':
                            if (timeDiff > 30 * 24 * 3600) return false;
                            break;
                    }
                }

                return true;
            });

            updateTasksTable(filteredTasks);
        }

        // æœç´¢ä»»åŠ¡
        function searchTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                updateTasksTable(filteredTasks);
                return;
            }

            const searchResults = filteredTasks.filter(task => {
                return task.task_id.toLowerCase().includes(searchTerm) ||
                       task.input_files.some(file => file.toLowerCase().includes(searchTerm));
            });

            updateTasksTable(searchResults);
        }

        // å¼€å§‹çŠ¶æ€è½®è¯¢
        function startStatusPolling() {
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€
            setInterval(async () => {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    
                    // æ›´æ–°æœåŠ¡çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('process-status').textContent = data.status === 'healthy' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                    document.getElementById('process-status').className = `badge badge-${data.status === 'healthy' ? 'success' : 'danger'}`;
                } catch (error) {
                    console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                }
            }, 30000);
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, confirmText = 'ç¡®è®¤', type = 'warning') {
            return new Promise((resolve) => {
                const confirmed = confirm(`${title}\n\n${message}`);
                resolve(confirmed);
            });
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetails(taskId) {
            const modal = document.getElementById('task-details-modal');
            const content = document.getElementById('task-details-content');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨åŠ è½½ä»»åŠ¡è¯¦æƒ…...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`/admin/api/tasks/${taskId}/details`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const task = result.data;
                    renderTaskDetails(task);
                } else {
                    content.innerHTML = `
                        <div class="result-error">
                            <h5>âŒ åŠ è½½å¤±è´¥</h5>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="result-error">
                        <h5>âŒ ç½‘ç»œé”™è¯¯</h5>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</p>
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡è¯¦æƒ…
        function renderTaskDetails(task) {
            const content = document.getElementById('task-details-content');
            const downloadBtn = document.getElementById('download-task-btn');
            
            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®ï¼ˆå¦‚æœæœ‰è¾“å‡ºæ–‡ä»¶ï¼‰
            if (task.output_files && task.output_files.length > 0) {
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => downloadTaskResults(task.task_id);
            } else {
                downloadBtn.style.display = 'none';
            }
            
            content.innerHTML = `
                <div class="task-details">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="task-basic-info">
                        <h4>ğŸ“‹ ä»»åŠ¡åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ä»»åŠ¡ID</span>
                                <span class="info-value"><code>${task.task_id}</code></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ä»»åŠ¡çŠ¶æ€</span>
                                <span class="info-value">
                                    <span class="badge badge-${getStatusColor(task.status)}">${getStatusText(task.status)}</span>
                                    ${task.is_old ? '<span class="badge badge-warning ml-2">è¿‡æœŸ</span>' : ''}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                                <span class="info-value">${formatDateTime(task.created_time)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœ€åæ›´æ–°</span>
                                <span class="info-value">${formatDateTime(task.latest_time)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ€»æ–‡ä»¶å¤§å°</span>
                                <span class="info-value">${formatFileSize(task.total_size)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ–‡ä»¶ç»Ÿè®¡</span>
                                <span class="info-value">è¾“å…¥ ${task.input_files.length} ä¸ª Â· è¾“å‡º ${task.output_files.length} ä¸ª</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶åˆ—è¡¨ -->
                    <div class="file-sections">
                        <!-- è¾“å…¥æ–‡ä»¶ -->
                        <div class="file-section">
                            <div class="file-section-header">
                                <h5>ğŸ“¤ è¾“å…¥æ–‡ä»¶ <span class="file-count-badge">${task.input_files.length}</span></h5>
                            </div>
                            ${task.input_files.length > 0 ? `
                                <ul class="file-list">
                                    ${task.input_files.map(file => `
                                        <li class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">${file.name}</div>
                                                <div class="file-path" title="${file.path}">${file.path}</div>
                                                <div class="file-meta">
                                                    <span>ğŸ“Š ${formatFileSize(file.size)}</span>
                                                    <span>ğŸ•’ ${formatDateTime(file.modified_time)}</span>
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <button class="btn btn-xs btn-secondary" onclick="copyToClipboard('${file.path}')" title="å¤åˆ¶æ–‡ä»¶è·¯å¾„">
                                                    ğŸ“‹ å¤åˆ¶è·¯å¾„
                                                </button>
                                                <button class="btn btn-xs btn-danger" onclick="deleteTaskFile('${file.path}', '${file.name}')" title="åˆ é™¤æ­¤æ–‡ä»¶">
                                                    ğŸ—‘ï¸ åˆ é™¤
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <div class="empty-state">
                                    <div class="empty-state-icon">ğŸ“</div>
                                    <p class="empty-state-text">æ²¡æœ‰è¾“å…¥æ–‡ä»¶</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- è¾“å‡ºæ–‡ä»¶ -->
                        <div class="file-section">
                            <div class="file-section-header">
                                <h5>ğŸ“¥ è¾“å‡ºæ–‡ä»¶ <span class="file-count-badge">${task.output_files.length}</span></h5>
                            </div>
                            ${task.output_files.length > 0 ? `
                                <ul class="file-list">
                                    ${task.output_files.map(file => `
                                        <li class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">${file.name}</div>
                                                <div class="file-path" title="${file.path}">${file.path}</div>
                                                <div class="file-meta">
                                                    <span>ğŸ“Š ${formatFileSize(file.size)}</span>
                                                    <span>ğŸ•’ ${formatDateTime(file.modified_time)}</span>
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <button class="btn btn-xs btn-primary" onclick="downloadFile('${file.path}', '${file.name}')" title="ä¸‹è½½æ­¤æ–‡ä»¶">
                                                    ğŸ“¥ ä¸‹è½½
                                                </button>
                                                <button class="btn btn-xs btn-secondary" onclick="copyToClipboard('${file.path}')" title="å¤åˆ¶æ–‡ä»¶è·¯å¾„">
                                                    ğŸ“‹ å¤åˆ¶è·¯å¾„
                                                </button>
                                                <button class="btn btn-xs btn-danger" onclick="deleteTaskFile('${file.path}', '${file.name}')" title="åˆ é™¤æ­¤æ–‡ä»¶">
                                                    ğŸ—‘ï¸ åˆ é™¤
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <div class="empty-state">
                                    <div class="empty-state-icon">ğŸ“‚</div>
                                    <p class="empty-state-text">æ²¡æœ‰è¾“å‡ºæ–‡ä»¶</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // å…³é—­ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡†
        function closeTaskDetailsModal() {
            const modal = document.getElementById('task-details-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                window.showMessage('æ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (error) {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    window.showMessage('æ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } catch (e) {
                    window.showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
                document.body.removeChild(textArea);
            }
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(filePath, fileName) {
            const url = `/admin/api/files/download?file_path=${encodeURIComponent(filePath)}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.showMessage(`æ­£åœ¨ä¸‹è½½ ${fileName}...`, 'info');
        }
        
        // åˆ é™¤ä»»åŠ¡æ–‡ä»¶
        async function deleteTaskFile(filePath, fileName) {
            const confirmed = await showConfirmDialog(
                'ç¡®è®¤åˆ é™¤æ–‡ä»¶',
                `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${fileName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,
                'åˆ é™¤',
                'danger'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/admin/api/files/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ file_path: filePath })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                                         // é‡æ–°åŠ è½½ä»»åŠ¡è¯¦æƒ…
                     const modal = document.getElementById('task-details-modal');
                     if (modal.style.display !== 'none') {
                         // ä»æ¨¡æ€æ¡†æ ‡é¢˜æˆ–å…¶ä»–åœ°æ–¹è·å–å½“å‰ä»»åŠ¡ID
                         const taskIdMatch = content.innerHTML.match(/task_id.*?<code>(.*?)<\/code>/);
                         if (taskIdMatch) {
                             viewTaskDetails(taskIdMatch[1]);
                         }
                     }
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä¸‹è½½ä»»åŠ¡è¾“å‡ºæ–‡ä»¶
        function downloadTaskResults(taskId) {
            window.showMessage('æ‰¹é‡ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        function cleanupOrphanedFiles() { window.showMessage('å­¤ç«‹æ–‡ä»¶æ¸…ç†åŠŸèƒ½å¼€å‘ä¸­...', 'info'); }
        function deleteOrphanedFile(path) { window.showMessage('å•ä¸ªæ–‡ä»¶åˆ é™¤åŠŸèƒ½å¼€å‘ä¸­...', 'info'); }
        function closeBatchModal() { document.getElementById('batch-modal').style.display = 'none'; }
        function executeBatchAction() { window.showMessage('æ‰¹é‡æ“ä½œåŠŸèƒ½å¼€å‘ä¸­...', 'info'); }
        function refreshLogs() { window.showMessage('æ—¥å¿—åˆ·æ–°åŠŸèƒ½å¼€å‘ä¸­...', 'info'); }
        function clearLogs() { document.getElementById('log-container').innerHTML = '<div class="log-entry"><span class="log-time">[æ—¥å¿—å·²æ¸…ç©º]</span><span class="log-level log-info">INFO</span><span class="log-message">æ—¥å¿—æ˜¾ç¤ºå·²æ¸…ç©º</span></div>'; }
    </script>
</body>
</html> 