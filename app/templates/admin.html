<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理面板 - Demucs 音频分离工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-flex">
                <h1>🛠️ 管理面板</h1>
                <div class="header-actions">
                    <a href="/" class="btn btn-secondary">🏠 返回首页</a>
                    <a href="/admin/logout" class="btn btn-outline">🚪 退出登录</a>
                </div>
            </div>
            <div class="main-nav">
                <a href="/" class="nav-link">🏠 首页</a>
                <a href="/mcp" class="nav-link">🔗 MCP协议</a>
                <a href="/api-docs" class="nav-link">📚 API文档</a>
                <a href="/docs" class="nav-link">📖 使用指南</a>
                <a href="/test-guide" class="nav-link">🧪 测试指南</a>
                <a href="/admin" class="nav-link active">🛠️ 管理面板</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 统计概览 -->
        <div class="card">
            <h2>📊 系统统计</h2>
            <div class="grid grid-4">
                <div class="stat-card card-primary">
                    <div class="stat-number" id="total-tasks">0</div>
                    <div class="stat-label">总任务数</div>
                </div>
                <div class="stat-card card-success">
                    <div class="stat-number" id="completed-tasks">0</div>
                    <div class="stat-label">已完成</div>
                </div>
                <div class="stat-card card-warning">
                    <div class="stat-number" id="processing-tasks">0</div>
                    <div class="stat-label">处理中</div>
                </div>
                <div class="stat-card card-danger">
                    <div class="stat-number" id="old-tasks">0</div>
                    <div class="stat-label">过期任务</div>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="card">
            <h2>⚡ 快速操作</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshData()">🔄 刷新数据</button>
                <button class="btn btn-success" onclick="downloadSystemInfo()">📊 导出统计</button>
                <button class="btn btn-warning" onclick="cleanupOldFiles()">🧹 清理过期文件</button>
                <button class="btn btn-danger" onclick="cleanupAllFiles()">🗑️ 清理所有文件</button>
            </div>
        </div>

        <!-- 服务器状态 -->
        <div class="card">
            <h2>💻 服务器状态</h2>
            <div class="grid grid-2">
                <div class="card" style="background: #f8f9fa;">
                    <h4>系统信息</h4>
                    <div id="system-info">
                        <p>CPU使用率: <span id="cpu-usage" class="badge">检查中...</span></p>
                        <p>内存使用: <span id="memory-usage" class="badge">检查中...</span></p>
                        <p>磁盘空间: <span id="disk-usage" class="badge">检查中...</span></p>
                        <p>运行时间: <span id="uptime" class="badge">检查中...</span></p>
                    </div>
                </div>
                <div class="card" style="background: #f8f9fa;">
                    <h4>服务状态</h4>
                    <div id="service-status">
                        <p>Web服务: <span id="web-status" class="badge badge-success">正常</span></p>
                        <p>处理服务: <span id="process-status" class="badge">检查中...</span></p>
                        <p>文件服务: <span id="file-status" class="badge">检查中...</span></p>
                        <p>数据库: <span id="db-status" class="badge">检查中...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务管理 -->
        <div class="card">
            <h2>📋 任务管理</h2>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label>状态筛选:</label>
                    <select id="status-filter" onchange="filterTasks()">
                        <option value="all">全部</option>
                        <option value="completed">已完成</option>
                        <option value="processing">处理中</option>
                        <option value="failed">失败</option>
                        <option value="old">过期</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>时间范围:</label>
                    <select id="time-filter" onchange="filterTasks()">
                        <option value="all">全部</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="search-input" placeholder="搜索任务ID或文件名..." onkeyup="searchTasks()">
                </div>
            </div>

            <div class="table-container">
                <table class="table" id="tasks-table">
                    <thead>
                        <tr>
                            <th>任务ID</th>
                            <th>状态</th>
                            <th>输入文件</th>
                            <th>输出文件</th>
                            <th>文件大小</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-body">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>正在加载任务数据...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 孤立文件管理 -->
        <div class="card">
            <h2>📄 孤立文件管理</h2>
            <p class="text-muted">这些文件没有对应的任务记录，可能是处理过程中产生的临时文件。</p>
            
            <div class="orphaned-files" id="orphaned-files">
                <div class="text-center">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>正在扫描孤立文件...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志查看 -->
        <div class="card">
            <h2>📜 系统日志</h2>
            <div class="log-controls">
                <select id="log-level">
                    <option value="all">全部级别</option>
                    <option value="error">错误</option>
                    <option value="warning">警告</option>
                    <option value="info">信息</option>
                </select>
                <button class="btn btn-primary btn-sm" onclick="refreshLogs()">刷新日志</button>
                <button class="btn btn-secondary btn-sm" onclick="clearLogs()">清空显示</button>
            </div>
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="log-time">[系统启动]</span>
                    <span class="log-level log-info">INFO</span>
                    <span class="log-message">管理面板加载完成</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚠️ 确认删除</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>您确定要删除这个任务及其所有相关文件吗？</p>
                <p class="text-danger"><strong>此操作无法撤销！</strong></p>
                <div id="delete-task-info"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 任务详情模态框 -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3>📋 任务详情</h3>
                <button class="modal-close" onclick="closeTaskDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="task-details-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>正在加载任务详情...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTaskDetailsModal()">关闭</button>
                <button class="btn btn-primary" onclick="downloadTaskResults()" id="download-task-btn" style="display: none;">📥 下载输出文件</button>
            </div>
        </div>
    </div>

    <!-- 批量操作模态框 -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📦 批量操作</h3>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>选择要执行的批量操作：</p>
                <div class="batch-options">
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-old">
                        <span>删除过期任务（超过7天）</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-failed">
                        <span>删除失败任务</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="batch-action" value="delete-all">
                        <span>删除所有任务</span>
                    </label>
                </div>
                <div id="batch-preview" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBatchModal()">取消</button>
                <button class="btn btn-warning" onclick="executeBatchAction()">执行操作</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>Demucs音频分离工具管理面板 &copy; 2024</p>
        </div>
    </footer>

    <!-- JavaScript文件 -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // 全局变量
        let allTasks = [];
        let filteredTasks = [];
        let deleteTaskId = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
        });

        // 初始化管理面板
        async function initializeAdmin() {
            await refreshData();
            startStatusPolling();
        }

        // 刷新数据
        async function refreshData() {
            window.showMessage('正在刷新数据...', 'info');
            
            try {
                // 获取任务数据
                const response = await fetch('/admin/api/files');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        updateStatistics(data.data.summary);
                        updateTasksTable(data.data.tasks);
                        updateOrphanedFiles(data.data.orphaned_files);
                        allTasks = data.data.tasks;
                        filteredTasks = [...allTasks];
                        window.showMessage('数据刷新成功', 'success');
                    }
                }
            } catch (error) {
                console.error('刷新数据失败:', error);
                window.showMessage('数据刷新失败: ' + error.message, 'error');
            }
        }

        // 更新统计信息
        function updateStatistics(summary) {
            document.getElementById('total-tasks').textContent = summary.total_tasks;
            document.getElementById('completed-tasks').textContent = summary.completed_tasks;
            document.getElementById('processing-tasks').textContent = summary.processing_tasks;
            document.getElementById('old-tasks').textContent = summary.old_tasks;
            
            // 添加扫描性能信息显示
            if (summary.scan_duration !== undefined) {
                const scanInfo = document.getElementById('scan-info');
                if (!scanInfo) {
                    // 创建扫描信息元素
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'scan-info';
                    infoDiv.className = 'scan-performance-info mt-2';
                    infoDiv.innerHTML = `
                        <small class="text-muted">
                            📊 扫描耗时: <span id="scan-duration">${summary.scan_duration.toFixed(2)}秒</span> | 
                            扫描文件: <span id="scan-files">${summary.scanned_files}</span>个
                            ${summary.scan_limited ? ' <span class="badge badge-warning">已限制</span>' : ''}
                            ${summary.tasks_truncated ? ' <span class="badge badge-info">任务已截断</span>' : ''}
                        </small>
                    `;
                    document.querySelector('.grid-4').after(infoDiv);
                } else {
                    // 更新现有信息
                    document.getElementById('scan-duration').textContent = `${summary.scan_duration.toFixed(2)}秒`;
                    document.getElementById('scan-files').textContent = summary.scanned_files;
                }
            }
        }

        // 更新任务表格
        function updateTasksTable(tasks) {
            const tbody = document.getElementById('tasks-body');
            
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无任务数据</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => `
                <tr class="task-row ${task.is_old ? 'task-old' : ''}" data-task-id="${task.task_id}">
                    <td>
                        <code>${task.task_id.substring(0, 8)}...</code>
                        ${task.is_old ? '<span class="badge badge-warning">过期</span>' : ''}
                    </td>
                    <td>
                        <span class="badge badge-${getStatusColor(task.status)}">${getStatusText(task.status)}</span>
                    </td>
                    <td>${task.input_files.length} 个文件</td>
                    <td>${task.output_files.length} 个文件</td>
                    <td>${formatFileSize(task.total_size)}</td>
                    <td>${formatDateTime(task.created_time)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="viewTaskDetails('${task.task_id}')">
                                📋 详情
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.task_id}')">
                                🗑️ 删除
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 更新孤立文件
        function updateOrphanedFiles(orphanedFiles) {
            const container = document.getElementById('orphaned-files');
            
            if (orphanedFiles.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">没有找到孤立文件</p>';
                return;
            }

            container.innerHTML = `
                <div class="orphaned-header">
                    <p>找到 ${orphanedFiles.length} 个孤立文件：</p>
                    <button class="btn btn-warning btn-sm" onclick="cleanupOrphanedFiles()">
                        🧹 清理所有孤立文件
                    </button>
                </div>
                <div class="orphaned-list">
                    ${orphanedFiles.map(file => `
                        <div class="orphaned-item">
                            <span class="file-name">${file.name}</span>
                            <span class="file-type badge">${file.type}</span>
                            <span class="file-size">${formatFileSize(file.size)}</span>
                            <button class="btn btn-sm btn-danger" onclick="deleteOrphanedFile('${file.path}')">
                                删除
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 获取状态颜色
        function getStatusColor(status) {
            const colors = {
                'completed': 'success',
                'processing': 'warning',
                'failed': 'danger',
                'pending': 'info'
            };
            return colors[status] || 'secondary';
        }

        // 获取状态文本
        function getStatusText(status) {
            const texts = {
                'completed': '已完成',
                'processing': '处理中',
                'failed': '失败',
                'pending': '等待中'
            };
            return texts[status] || status;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化日期时间
        function formatDateTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }

        // 删除任务
        function deleteTask(taskId) {
            deleteTaskId = taskId;
            const task = allTasks.find(t => t.task_id === taskId);
            if (task) {
                document.getElementById('delete-task-info').innerHTML = `
                    <div class="task-info">
                        <p><strong>任务ID:</strong> ${taskId}</p>
                        <p><strong>输入文件:</strong> ${task.input_files.length} 个</p>
                        <p><strong>输出文件:</strong> ${task.output_files.length} 个</p>
                        <p><strong>总大小:</strong> ${formatFileSize(task.total_size)}</p>
                    </div>
                `;
            }
            // 修复弹窗显示逻辑
            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // 添加点击背景关闭功能
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeDeleteModal();
                }
            };
        }

        // 确认删除
        async function confirmDelete() {
            if (!deleteTaskId) return;

            // 显示加载状态
            const confirmBtn = document.querySelector('#delete-modal .btn-danger');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = '删除中...';
            confirmBtn.disabled = true;

            try {
                const response = await fetch('/admin/api/tasks/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_id: deleteTaskId })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('删除失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }

            closeDeleteModal();
        }

        // 关闭删除模态框
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                deleteTaskId = null;
            }, 300);
        }

        // 清理过期文件
        async function cleanupOldFiles() {
            // 创建自定义确认弹窗
            const confirmed = await showConfirmDialog(
                '清理过期文件',
                '确定要清理所有过期文件吗？这将删除超过保留期限的所有文件。',
                '清理',
                'warning'
            );
            
            if (!confirmed) return;

            try {
                window.showMessage('正在清理过期文件...', 'info');
                const response = await fetch('/admin/api/cleanup/old', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('清理失败: ' + error.message, 'error');
            }
        }

        // 清理所有文件
        async function cleanupAllFiles() {
            const confirmed = await showConfirmDialog(
                '⚠️ 危险操作',
                '确定要清理所有文件吗？这将删除所有上传和输出文件，此操作无法撤销！',
                '确认清理',
                'danger'
            );
            
            if (!confirmed) return;

            try {
                window.showMessage('正在清理所有文件...', 'info');
                const response = await fetch('/admin/api/cleanup/all', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage(result.message, 'success');
                    await refreshData();
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('清理失败: ' + error.message, 'error');
            }
        }

        // 自定义确认对话框
        function showConfirmDialog(title, message, confirmText = '确认', type = 'warning') {
            return new Promise((resolve) => {
                // 创建对话框HTML
                const dialogHtml = `
                    <div id="custom-confirm-modal" class="modal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${title}</h3>
                                <button class="modal-close" onclick="closeCustomConfirm(false)">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeCustomConfirm(false)">取消</button>
                                <button class="btn btn-${type}" onclick="closeCustomConfirm(true)">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', dialogHtml);
                
                // 设置全局回调
                window.customConfirmResolve = resolve;
            });
        }

        // 关闭自定义确认对话框
        function closeCustomConfirm(result) {
            const modal = document.getElementById('custom-confirm-modal');
            if (modal) {
                modal.remove();
            }
            if (window.customConfirmResolve) {
                window.customConfirmResolve(result);
                delete window.customConfirmResolve;
            }
        }

        // 下载系统信息
        function downloadSystemInfo() {
            const data = {
                timestamp: new Date().toISOString(),
                statistics: {
                    total_tasks: document.getElementById('total-tasks').textContent,
                    completed_tasks: document.getElementById('completed-tasks').textContent,
                    processing_tasks: document.getElementById('processing-tasks').textContent,
                    old_tasks: document.getElementById('old-tasks').textContent
                },
                tasks: allTasks
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `demucs-admin-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            window.showMessage('系统信息已导出', 'success');
        }

        // 筛选任务
        function filterTasks() {
            const statusFilter = document.getElementById('status-filter').value;
            const timeFilter = document.getElementById('time-filter').value;

            filteredTasks = allTasks.filter(task => {
                // 状态筛选
                if (statusFilter !== 'all') {
                    if (statusFilter === 'old' && !task.is_old) return false;
                    if (statusFilter !== 'old' && task.status !== statusFilter) return false;
                }

                // 时间筛选
                if (timeFilter !== 'all') {
                    const now = Date.now() / 1000;
                    const taskTime = task.created_time;
                    const timeDiff = now - taskTime;

                    switch (timeFilter) {
                        case 'today':
                            if (timeDiff > 24 * 3600) return false;
                            break;
                        case 'week':
                            if (timeDiff > 7 * 24 * 3600) return false;
                            break;
                        case 'month':
                            if (timeDiff > 30 * 24 * 3600) return false;
                            break;
                    }
                }

                return true;
            });

            updateTasksTable(filteredTasks);
        }

        // 搜索任务
        function searchTasks() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                updateTasksTable(filteredTasks);
                return;
            }

            const searchResults = filteredTasks.filter(task => {
                return task.task_id.toLowerCase().includes(searchTerm) ||
                       task.input_files.some(file => file.toLowerCase().includes(searchTerm));
            });

            updateTasksTable(searchResults);
        }

        // 开始状态轮询
        function startStatusPolling() {
            // 每30秒检查一次系统状态
            setInterval(async () => {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    
                    // 更新服务状态显示
                    document.getElementById('process-status').textContent = data.status === 'healthy' ? '正常' : '异常';
                    document.getElementById('process-status').className = `badge badge-${data.status === 'healthy' ? 'success' : 'danger'}`;
                } catch (error) {
                    console.error('状态检查失败:', error);
                }
            }, 30000);
        }
        
        // 显示确认对话框
        function showConfirmDialog(title, message, confirmText = '确认', type = 'warning') {
            return new Promise((resolve) => {
                const confirmed = confirm(`${title}\n\n${message}`);
                resolve(confirmed);
            });
        }

        // 查看任务详情
        async function viewTaskDetails(taskId) {
            const modal = document.getElementById('task-details-modal');
            const content = document.getElementById('task-details-content');
            
            // 显示模态框
            modal.style.display = 'flex';
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
            
            // 显示加载状态
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>正在加载任务详情...</span>
                </div>
            `;
            
            try {
                const response = await fetch(`/admin/api/tasks/${taskId}/details`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const task = result.data;
                    renderTaskDetails(task);
                } else {
                    content.innerHTML = `
                        <div class="result-error">
                            <h5>❌ 加载失败</h5>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="result-error">
                        <h5>❌ 网络错误</h5>
                        <p>无法连接到服务器，请检查网络连接。</p>
                    </div>
                `;
            }
        }
        
        // 渲染任务详情
        function renderTaskDetails(task) {
            const content = document.getElementById('task-details-content');
            const downloadBtn = document.getElementById('download-task-btn');
            
            // 显示下载按钮（如果有输出文件）
            if (task.output_files && task.output_files.length > 0) {
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => downloadTaskResults(task.task_id);
            } else {
                downloadBtn.style.display = 'none';
            }
            
            content.innerHTML = `
                <div class="task-details">
                    <!-- 基本信息 -->
                    <div class="task-basic-info">
                        <h4>📋 任务基本信息</h4>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">任务ID</span>
                                <span class="info-value"><code>${task.task_id}</code></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">任务状态</span>
                                <span class="info-value">
                                    <span class="badge badge-${getStatusColor(task.status)}">${getStatusText(task.status)}</span>
                                    ${task.is_old ? '<span class="badge badge-warning ml-2">过期</span>' : ''}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">创建时间</span>
                                <span class="info-value">${formatDateTime(task.created_time)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">最后更新</span>
                                <span class="info-value">${formatDateTime(task.latest_time)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">总文件大小</span>
                                <span class="info-value">${formatFileSize(task.total_size)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">文件统计</span>
                                <span class="info-value">输入 ${task.input_files.length} 个 · 输出 ${task.output_files.length} 个</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 文件列表 -->
                    <div class="file-sections">
                        <!-- 输入文件 -->
                        <div class="file-section">
                            <div class="file-section-header">
                                <h5>📤 输入文件 <span class="file-count-badge">${task.input_files.length}</span></h5>
                            </div>
                            ${task.input_files.length > 0 ? `
                                <ul class="file-list">
                                    ${task.input_files.map(file => `
                                        <li class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">${file.name}</div>
                                                <div class="file-path" title="${file.path}">${file.path}</div>
                                                <div class="file-meta">
                                                    <span>📊 ${formatFileSize(file.size)}</span>
                                                    <span>🕒 ${formatDateTime(file.modified_time)}</span>
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <button class="btn btn-xs btn-secondary" onclick="copyToClipboard('${file.path}')" title="复制文件路径">
                                                    📋 复制路径
                                                </button>
                                                <button class="btn btn-xs btn-danger" onclick="deleteTaskFile('${file.path}', '${file.name}')" title="删除此文件">
                                                    🗑️ 删除
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <div class="empty-state">
                                    <div class="empty-state-icon">📁</div>
                                    <p class="empty-state-text">没有输入文件</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- 输出文件 -->
                        <div class="file-section">
                            <div class="file-section-header">
                                <h5>📥 输出文件 <span class="file-count-badge">${task.output_files.length}</span></h5>
                            </div>
                            ${task.output_files.length > 0 ? `
                                <ul class="file-list">
                                    ${task.output_files.map(file => `
                                        <li class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">${file.name}</div>
                                                <div class="file-path" title="${file.path}">${file.path}</div>
                                                <div class="file-meta">
                                                    <span>📊 ${formatFileSize(file.size)}</span>
                                                    <span>🕒 ${formatDateTime(file.modified_time)}</span>
                                                </div>
                                            </div>
                                            <div class="file-actions">
                                                <button class="btn btn-xs btn-primary" onclick="downloadFile('${file.path}', '${file.name}')" title="下载此文件">
                                                    📥 下载
                                                </button>
                                                <button class="btn btn-xs btn-secondary" onclick="copyToClipboard('${file.path}')" title="复制文件路径">
                                                    📋 复制路径
                                                </button>
                                                <button class="btn btn-xs btn-danger" onclick="deleteTaskFile('${file.path}', '${file.name}')" title="删除此文件">
                                                    🗑️ 删除
                                                </button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <div class="empty-state">
                                    <div class="empty-state-icon">📂</div>
                                    <p class="empty-state-text">没有输出文件</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 关闭任务详情模态框
        function closeTaskDetailsModal() {
            const modal = document.getElementById('task-details-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // 复制到剪贴板
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                window.showMessage('文件路径已复制到剪贴板', 'success');
            } catch (error) {
                // 降级到传统方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    window.showMessage('文件路径已复制到剪贴板', 'success');
                } catch (e) {
                    window.showMessage('复制失败，请手动复制', 'error');
                }
                document.body.removeChild(textArea);
            }
        }
        
        // 下载文件
        function downloadFile(filePath, fileName) {
            const url = `/admin/api/files/download?file_path=${encodeURIComponent(filePath)}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.showMessage(`正在下载 ${fileName}...`, 'info');
        }
        
        // 删除任务文件
        async function deleteTaskFile(filePath, fileName) {
            const confirmed = await showConfirmDialog(
                '确认删除文件',
                `确定要删除文件 "${fileName}" 吗？此操作无法撤销。`,
                '删除',
                'danger'
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/admin/api/files/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ file_path: filePath })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    window.showMessage('文件删除成功', 'success');
                                         // 重新加载任务详情
                     const modal = document.getElementById('task-details-modal');
                     if (modal.style.display !== 'none') {
                         // 从模态框标题或其他地方获取当前任务ID
                         const taskIdMatch = content.innerHTML.match(/task_id.*?<code>(.*?)<\/code>/);
                         if (taskIdMatch) {
                             viewTaskDetails(taskIdMatch[1]);
                         }
                     }
                } else {
                    window.showMessage(result.message, 'error');
                }
            } catch (error) {
                window.showMessage('删除失败: ' + error.message, 'error');
            }
        }
        
        // 下载任务输出文件
        function downloadTaskResults(taskId) {
            window.showMessage('批量下载功能开发中...', 'info');
        }
        function cleanupOrphanedFiles() { window.showMessage('孤立文件清理功能开发中...', 'info'); }
        function deleteOrphanedFile(path) { window.showMessage('单个文件删除功能开发中...', 'info'); }
        function closeBatchModal() { document.getElementById('batch-modal').style.display = 'none'; }
        function executeBatchAction() { window.showMessage('批量操作功能开发中...', 'info'); }
        function refreshLogs() { window.showMessage('日志刷新功能开发中...', 'info'); }
        function clearLogs() { document.getElementById('log-container').innerHTML = '<div class="log-entry"><span class="log-time">[日志已清空]</span><span class="log-level log-info">INFO</span><span class="log-message">日志显示已清空</span></div>'; }
    </script>
</body>
</html> 